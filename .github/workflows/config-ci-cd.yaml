name: Config CI/CD

on:
  push:
    branches:
      - dev
    paths:
      - 'config-repo/**'

permissions:
  id-token: write
  contents: read

jobs:
  detect-config-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.detect.outputs.services }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed config services
        id: detect
        run: |
          git fetch origin dev
          
          # config-repo/application.yml 변경 확인
          APPLICATION_CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^config-repo/application\.yml$' | wc -l)
          
          # config-repo/ 폴더에서 변경된 개별 설정 파일들 찾기
          CONFIG_SERVICES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^config-repo/.*\.yml$' | grep -v '^config-repo/application\.yml$' | sed 's|config-repo/||g' | sed 's|\.yml||g' | sort | uniq)
          
          # application.yml이 바뀌면 모든 서비스 재시작
          if [ "$APPLICATION_CHANGED" -gt 0 ]; then
            ALL_SERVICES="auth gateway schedule recommend review"
          else
            # 그렇지 않으면 변경된 서비스들만
            ALL_SERVICES="$CONFIG_SERVICES"
          fi
          
          # JSON 배열로 변환
          CHANGED=$(echo "$ALL_SERVICES" | tr ' ' '\n' | sort | uniq | jq -R -s -c 'split("\n") | map(select(. != ""))')
          echo "services=$CHANGED" >> $GITHUB_OUTPUT

  restart-services:
    needs: detect-config-changes
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.detect-config-changes.outputs.services) != '[]' }}
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-config-changes.outputs.services) }}
      fail-fast: false
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/mapzip-dev-GitHubActionsOIDCRole
          role-session-name: GitHub_to_AWS_via_FederatedOIDC
          aws-region: ap-northeast-2

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig --region ap-northeast-2 --name mapzip-dev-eks

      - name: Restart ${{ matrix.service }} service
        run: |
          SERVICE="${{ matrix.service }}"
          echo "Restarting $SERVICE service..."
          
          # 서비스별 deployment 이름과 네임스페이스 매핑
          case $SERVICE in
            "auth")
              DEPLOYMENT="auth-deployment"
              NAMESPACE="service-platform"
              ;;
            "gateway")
              DEPLOYMENT="spring-gateway-deployment"
              NAMESPACE="service-platform"
              ;;
            "schedule")
              DEPLOYMENT="schedule-deployment"
              NAMESPACE="service-schedule"
              ;;
            "recommend")
              DEPLOYMENT="recommend-deployment"
              NAMESPACE="service-recommend"
              ;;
            "review")
              DEPLOYMENT="review-deployment"
              NAMESPACE="service-review"
              ;;
            *)
              echo "Unknown service: $SERVICE"
              exit 1
              ;;
          esac
          
          kubectl rollout restart deployment/$DEPLOYMENT -n $NAMESPACE
          kubectl rollout status deployment/$DEPLOYMENT -n $NAMESPACE --timeout=300s
          
          echo "✅ $SERVICE service restarted successfully in $NAMESPACE namespace"
